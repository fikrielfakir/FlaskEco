{% extends "base.html" %}

{% block title %}Gestion de Production - EcoQuality{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-boxes me-2"></i>Gestion de Production</h1>
        <a href="{{ url_for('create_batch') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Nouveau Lot
        </a>
    </div>
    
    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="search" class="form-label">Recherche</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           value="{{ search }}" placeholder="Numéro de lot ou type de produit">
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Statut</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">Tous les statuts</option>
                        <option value="planned" {% if status_filter == 'planned' %}selected{% endif %}>Planifié</option>
                        <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>En cours</option>
                        <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Terminé</option>
                        <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approuvé</option>
                        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejeté</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search me-1"></i>Filtrer
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Production Batches -->
    <div class="row">
        {% for batch in batches %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>{{ batch.lot_number }}</strong>
                        <span class="badge bg-{% if batch.status == 'approved' %}success{% elif batch.status == 'completed' %}info{% elif batch.status == 'in_progress' %}warning{% elif batch.status == 'rejected' %}danger{% else %}secondary{% endif %}">
                            {{ batch.status }}
                        </span>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            <strong>Produit:</strong> {{ batch.product_type }}<br>
                            <strong>Quantité:</strong> {{ batch.actual_quantity or 0 }} / {{ batch.planned_quantity }}<br>
                            <strong>Four:</strong> {{ batch.kiln_number }}<br>
                            <strong>Date:</strong> {{ batch.production_date.strftime('%d/%m/%Y') }}<br>
                            {% if batch.supervisor %}
                                <strong>Superviseur:</strong> {{ batch.supervisor.username }}
                            {% endif %}
                        </p>
                        
                        {% if batch.kiln_temperature %}
                            <small class="text-muted">
                                Température: {{ batch.kiln_temperature }}°C
                                {% if batch.firing_duration %} | Durée: {{ batch.firing_duration }}h{% endif %}
                            </small>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <a href="{{ url_for('view_batch', batch_id=batch.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>Détails
                        </a>
                        {% if batch.status == 'completed' %}
                            <a href="{{ url_for('create_test') }}?batch_id={{ batch.id }}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-vial me-1"></i>Test
                            </a>
                        {% endif %}
                        <form method="POST" action="{{ url_for('delete_batch', batch_id=batch.id) }}" class="d-inline" 
                              onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer le lot {{ batch.lot_number }}? Cette action est irréversible.')">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash me-1"></i>Supprimer
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    Aucun lot de production trouvé. <a href="{{ url_for('create_batch') }}">Créer le premier lot</a>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
