{% extends "base.html" %}

{% block title %}Contrôle Qualité - EcoQuality{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-check-circle me-2"></i>Contrôle Qualité</h1>
        <div class="btn-toolbar" role="toolbar">
            <div class="btn-group me-2" role="group">
                <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-2"></i>Exporter
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('export_quality_tests', format_type='pdf', search=search, test_type=test_type) }}">
                        <i class="fas fa-file-pdf me-2"></i>PDF
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('export_quality_tests', format_type='excel', search=search, test_type=test_type) }}">
                        <i class="fas fa-file-excel me-2"></i>Excel
                    </a></li>
                </ul>
            </div>
            <div class="btn-group me-2" role="group">
                <form action="{{ url_for('initialize_iso_standards') }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-outline-info">
                        <i class="fas fa-cog me-2"></i>Initialiser ISO 10545
                    </button>
                </form>
            </div>
            <a href="{{ url_for('create_test') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Nouveau Test
            </a>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="search" class="form-label">Recherche par Lot</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           value="{{ search }}" placeholder="Numéro de lot">
                </div>
                <div class="col-md-3">
                    <label for="test_type" class="form-label">Type de Test</label>
                    <select class="form-select" id="test_type" name="test_type">
                        <option value="">Tous les types</option>
                        <option value="dimensional" {% if test_type == 'dimensional' %}selected{% endif %}>Dimensionnel</option>
                        <option value="water_absorption" {% if test_type == 'water_absorption' %}selected{% endif %}>Absorption d'eau</option>
                        <option value="breaking_strength" {% if test_type == 'breaking_strength' %}selected{% endif %}>Résistance à la rupture</option>
                        <option value="abrasion" {% if test_type == 'abrasion' %}selected{% endif %}>Résistance à l'abrasion</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search me-1"></i>Filtrer
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Test Results -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Résultats des Tests</h5>
        </div>
        <div class="card-body">
            {% if tests %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Échantillon</th>
                                <th>Lot</th>
                                <th>Type de Test</th>
                                <th>Norme ISO</th>
                                <th>Classification</th>
                                <th>Technicien</th>
                                <th>Score</th>
                                <th>Résultat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test in tests %}
                                <tr>
                                    <td>{{ test.test_date.strftime('%d/%m/%Y') }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ test.sample_id or 'N/A' }}</span>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('view_batch', batch_id=test.batch.id) }}" class="text-decoration-none">
                                            {{ test.batch.lot_number }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ test.test_type }}</span>
                                    </td>
                                    <td>{{ test.iso_standard or '-' }}</td>
                                    <td>
                                        {% if test.tile_classification %}
                                            <span class="badge bg-{% if test.tile_classification == 'BIa' %}success{% elif test.tile_classification in ['BIIa', 'BIIb'] %}warning{% else %}secondary{% endif %}">
                                                {{ test.tile_classification }}
                                            </span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ test.technician.username }}</td>
                                    <td>
                                        {% if test.compliance_score %}
                                            {{ "%.1f"|format(test.compliance_score) }}%
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if test.result == 'pass' %}success{% else %}danger{% endif %}">
                                            {% if test.result == 'pass' %}
                                                Conforme
                                            {% else %}
                                                Non Conforme
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('view_test', test_id=test.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="{{ url_for('export_single_quality_test', test_id=test.id, format_type='pdf') }}">
                                                    <i class="fas fa-file-pdf me-2"></i>PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="{{ url_for('export_single_quality_test', test_id=test.id, format_type='excel') }}">
                                                    <i class="fas fa-file-excel me-2"></i>Excel
                                                </a></li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    Aucun test de qualité trouvé. <a href="{{ url_for('create_test') }}">Créer le premier test</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
